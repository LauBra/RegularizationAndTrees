<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>Decision Trees in Classification (tidymodels) – HDS MSc - Module 3 - Overfitting, DT &amp; RF</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>

<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./random_forest_tidymodels_exercise.html" rel="next">
<link href="./Classification_Performance_tidymodels_ROC.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-6e1ef360f16fe2768cc3d2c841dec8bb.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light"><script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
</head>
<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top"><nav class="navbar navbar-expand-lg " data-bs-theme="dark"><div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">HDS MSc - Module 3 - Overfitting, DT &amp; RF</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
<li class="nav-item">
    <a class="nav-link active" href="./1_EvaluationMetrics_tidymodels.html" aria-current="page"> 
<span class="menu-text">Overfitting, DT and RF</span></a>
  </li>  
</ul>
</div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav><nav class="quarto-secondary-nav"><div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./DecisionTree_tidymodels_section.html">Decision Trees in Classification (tidymodels)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav></header><!-- content --><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto"><div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
<li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./1_EvaluationMetrics_tidymodels.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluate Performance in Regression (tidymodels)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Classification_Performance_tidymodels_ROC.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluate Performance in Classification (tidymodels)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./DecisionTree_tidymodels_section.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Decision Trees in Classification (tidymodels)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./random_forest_tidymodels_exercise.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Random Forest Classification (tidymodels)</span></a>
  </div>
</li>
    </ul>
</div>
</nav><div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active"><h2 id="toc-title">On this page</h2>
   
  <ul>
<li>
<a href="#fitting-a-classification-decision-tree-tidymodels" id="toc-fitting-a-classification-decision-tree-tidymodels" class="nav-link active" data-scroll-target="#fitting-a-classification-decision-tree-tidymodels">Fitting a classification decision tree (tidymodels)</a>
  <ul class="collapse">
<li><a href="#data-preparation-and-split" id="toc-data-preparation-and-split" class="nav-link" data-scroll-target="#data-preparation-and-split">1. Data preparation and split</a></li>
  <li><a href="#basic-decision-tree-no-tuning" id="toc-basic-decision-tree-no-tuning" class="nav-link" data-scroll-target="#basic-decision-tree-no-tuning">2. Basic decision tree (no tuning)</a></li>
  <li><a href="#visualise-the-basic-tree" id="toc-visualise-the-basic-tree" class="nav-link" data-scroll-target="#visualise-the-basic-tree">3. Visualise the basic tree</a></li>
  <li><a href="#predictions-and-performance-basic-tree" id="toc-predictions-and-performance-basic-tree" class="nav-link" data-scroll-target="#predictions-and-performance-basic-tree">4. Predictions and performance (basic tree)</a></li>
  </ul>
</li>
  <li>
<a href="#hyperparameters-manual-change" id="toc-hyperparameters-manual-change" class="nav-link" data-scroll-target="#hyperparameters-manual-change">Hyperparameters (manual change)</a>
  <ul class="collapse">
<li><a href="#evaluate-the-shallow-tree" id="toc-evaluate-the-shallow-tree" class="nav-link" data-scroll-target="#evaluate-the-shallow-tree">Evaluate the shallow tree</a></li>
  </ul>
</li>
  <li>
<a href="#hyperparameter-tuning-with-tidymodels" id="toc-hyperparameter-tuning-with-tidymodels" class="nav-link" data-scroll-target="#hyperparameter-tuning-with-tidymodels">Hyperparameter tuning with tidymodels</a>
  <ul class="collapse">
<li><a href="#create-a-tunable-tree-specification" id="toc-create-a-tunable-tree-specification" class="nav-link" data-scroll-target="#create-a-tunable-tree-specification">1. Create a tunable tree specification</a></li>
  <li><a href="#define-a-tuning-grid" id="toc-define-a-tuning-grid" class="nav-link" data-scroll-target="#define-a-tuning-grid">3. Define a tuning grid</a></li>
  <li><a href="#run-tune_grid" id="toc-run-tune_grid" class="nav-link" data-scroll-target="#run-tune_grid">4. Run <code>tune_grid()</code></a></li>
  <li><a href="#evaluate-the-tuned-tree-on-the-test-set" id="toc-evaluate-the-tuned-tree-on-the-test-set" class="nav-link" data-scroll-target="#evaluate-the-tuned-tree-on-the-test-set">5. Evaluate the tuned tree on the test set</a></li>
  <li><a href="#key-messages" id="toc-key-messages" class="nav-link" data-scroll-target="#key-messages">Key messages</a></li>
  </ul>
</li>
  </ul></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block default"><div class="quarto-title">
<div class="quarto-title-block"><div><h1 class="title">Decision Trees in Classification (tidymodels)</h1><button type="button" class="btn code-tools-button" id="quarto-code-tools-source"><i class="bi"></i> Code</button></div></div>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header><section id="fitting-a-classification-decision-tree-tidymodels" class="level2"><h2 class="anchored" data-anchor-id="fitting-a-classification-decision-tree-tidymodels">Fitting a classification decision tree (tidymodels)</h2>
<div class="cell">
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mlbench</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://www.milbo.org/rpart-plot/index.html">rpart.plot</a></span><span class="op">)</span>   <span class="co"># for plotting the fitted rpart tree</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/get_theme.html">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="data-preparation-and-split" class="level3"><h3 class="anchored" data-anchor-id="data-preparation-and-split">1. Data preparation and split</h3>
<div class="cell">
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Load the dataset and inspect</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span><span class="op">(</span><span class="st">"PimaIndiansDiabetes"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pima</span> <span class="op">&lt;-</span> <span class="va">PimaIndiansDiabetes</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    diabetes <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">diabetes</span><span class="op">)</span>,</span>
<span>    diabetes <span class="op">=</span> <span class="fu">forcats</span><span class="fu">::</span><span class="fu"><a href="https://forcats.tidyverse.org/reference/fct_relevel.html">fct_relevel</a></span><span class="op">(</span><span class="va">diabetes</span>, <span class="st">"pos"</span>, <span class="st">"neg"</span><span class="op">)</span> <span class="co"># make 'pos' the event</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/levels.html">levels</a></span><span class="op">(</span><span class="va">pima</span><span class="op">$</span><span class="va">diabetes</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "pos" "neg"</code></pre>
</div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">pima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 9
  pregnant glucose pressure triceps insulin  mass pedigree   age diabetes
     &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;fct&gt;   
1        6     148       72      35       0  33.6    0.627    50 pos     
2        1      85       66      29       0  26.6    0.351    31 neg     
3        8     183       64       0       0  23.3    0.672    32 pos     
4        1      89       66      23      94  28.1    0.167    21 neg     
5        0     137       40      35     168  43.1    2.29     33 pos     
6        5     116       74       0       0  25.6    0.201    30 neg     </code></pre>
</div>
</div>
<p>We split into <strong>training</strong> and <strong>testing</strong> datasets (70/30), stratifying by the outcome:</p>
<div class="cell">
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">pima</span>, prop <span class="op">=</span> <span class="fl">0.7</span>, strata <span class="op">=</span> <span class="va">diabetes</span><span class="op">)</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span>  <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">pima</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 768   9</code></pre>
</div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 537   9</code></pre>
</div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 231   9</code></pre>
</div>
</div>
</section><section id="basic-decision-tree-no-tuning" class="level3"><h3 class="anchored" data-anchor-id="basic-decision-tree-no-tuning">2. Basic decision tree (no tuning)</h3>
<p>We start with a very simple tree model using <strong>all predictors</strong>.</p>
<div class="cell">
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="co"># Model specification: basic classification tree</span></span>
<span><span class="va">tree_spec_basic</span> <span class="op">&lt;-</span> <span class="fu">decision_tree</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"rpart"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Recipe: use all predictors as-is</span></span>
<span><span class="va">tree_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">diabetes</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Workflow: model + recipe</span></span>
<span><span class="va">tree_wf_basic</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">tree_spec_basic</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_wf_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow ════════════════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
Decision Tree Model Specification (classification)

Computational engine: rpart </code></pre>
</div>
</div>
<p>Fit the workflow on the <strong>training set</strong>:</p>
<div class="cell">
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_fit_basic</span> <span class="op">&lt;-</span> <span class="va">tree_wf_basic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_fit_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
n= 537 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

  1) root 537 187 neg (0.34823091 0.65176909)  
    2) glucose&gt;=127.5 189  71 pos (0.62433862 0.37566138)  
      4) mass&gt;=29.95 142  39 pos (0.72535211 0.27464789)  
        8) glucose&gt;=157.5 62   6 pos (0.90322581 0.09677419) *
        9) glucose&lt; 157.5 80  33 pos (0.58750000 0.41250000)  
         18) pressure&lt; 61 12   0 pos (1.00000000 0.00000000) *
         19) pressure&gt;=61 68  33 pos (0.51470588 0.48529412)  
           38) age&gt;=30.5 42  14 pos (0.66666667 0.33333333)  
             76) pedigree&gt;=0.415 25   4 pos (0.84000000 0.16000000) *
             77) pedigree&lt; 0.415 17   7 neg (0.41176471 0.58823529) *
           39) age&lt; 30.5 26   7 neg (0.26923077 0.73076923) *
      5) mass&lt; 29.95 47  15 neg (0.31914894 0.68085106)  
       10) age&gt;=27.5 31  14 neg (0.45161290 0.54838710)  
         20) insulin&gt;=69.5 13   4 pos (0.69230769 0.30769231) *
         21) insulin&lt; 69.5 18   5 neg (0.27777778 0.72222222) *
       11) age&lt; 27.5 16   1 neg (0.06250000 0.93750000) *
    3) glucose&lt; 127.5 348  69 neg (0.19827586 0.80172414)  
      6) age&gt;=28.5 154  53 neg (0.34415584 0.65584416)  
       12) mass&gt;=26.35 128  52 neg (0.40625000 0.59375000)  
         24) pedigree&gt;=0.561 35  12 pos (0.65714286 0.34285714)  
           48) glucose&gt;=96.5 26   6 pos (0.76923077 0.23076923) *
           49) glucose&lt; 96.5 9   3 neg (0.33333333 0.66666667) *
         25) pedigree&lt; 0.561 93  29 neg (0.31182796 0.68817204)  
           50) triceps&lt; 27.5 54  22 neg (0.40740741 0.59259259)  
            100) glucose&gt;=93.5 44  22 pos (0.50000000 0.50000000)  
              200) pressure&lt; 84 36  15 pos (0.58333333 0.41666667)  
                400) pregnant&lt; 7.5 25   7 pos (0.72000000 0.28000000)  
                  800) pedigree&lt; 0.379 18   2 pos (0.88888889 0.11111111) *
                  801) pedigree&gt;=0.379 7   2 neg (0.28571429 0.71428571) *
                401) pregnant&gt;=7.5 11   3 neg (0.27272727 0.72727273) *
              201) pressure&gt;=84 8   1 neg (0.12500000 0.87500000) *
            101) glucose&lt; 93.5 10   0 neg (0.00000000 1.00000000) *
           51) triceps&gt;=27.5 39   7 neg (0.17948718 0.82051282) *
       13) mass&lt; 26.35 26   1 neg (0.03846154 0.96153846) *
      7) age&lt; 28.5 194  16 neg (0.08247423 0.91752577) *</code></pre>
</div>
</div>
</section><section id="visualise-the-basic-tree" class="level3"><h3 class="anchored" data-anchor-id="visualise-the-basic-tree">3. Visualise the basic tree</h3>
<p>We can extract the underlying <code>rpart</code> object and use <code><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot()</a></code>:</p>
<div class="cell">
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_fit_basic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span>extra <span class="op">=</span> <span class="fl">101</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot retrieve the data used to build the model (so cannot determine roundint and is.binary for the variables).
To silence this warning:
    Call rpart.plot with roundint=FALSE,
    or rebuild the rpart model with model=TRUE.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="DecisionTree_tidymodels_section_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr></section><section id="predictions-and-performance-basic-tree" class="level3"><h3 class="anchored" data-anchor-id="predictions-and-performance-basic-tree">4. Predictions and performance (basic tree)</h3>
<p>We now evaluate performance on <strong>train</strong> and <strong>test</strong> data.</p>
<section id="training-predictions" class="level4"><h4 class="anchored" data-anchor-id="training-predictions">4.1 Training predictions</h4>
<div class="cell">
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_preds_basic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_basic</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_basic</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">train_preds_basic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  .pred_pos .pred_neg .pred_class pregnant glucose pressure triceps insulin
      &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1    0.0825     0.918 neg                1      89       66      23      94
2    0.273      0.727 neg               10     115        0       0       0
3    0.125      0.875 neg                4     110       92       0       0
4    0.179      0.821 neg                1     103       30      38      83
5    0.0825     0.918 neg                1      97       66      15     140
6    0.692      0.308 pos               13     145       82      19     110
# ℹ 4 more variables: mass &lt;dbl&gt;, pedigree &lt;dbl&gt;, age &lt;dbl&gt;, diabetes &lt;fct&gt;</code></pre>
</div>
</div>
<p>The <code>.pred_pos</code> column contains the estimated probability of <code>"pos"</code> (diabetes present), and <code>.pred_class</code> is the predicted class using the default threshold 0.5.</p>
</section><section id="testing-predictions" class="level4"><h4 class="anchored" data-anchor-id="testing-predictions">4.2 Testing predictions</h4>
<div class="cell">
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_preds_basic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_basic</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_basic</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">test_preds_basic</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 12
  .pred_pos .pred_neg .pred_class pregnant glucose pressure triceps insulin
      &lt;dbl&gt;     &lt;dbl&gt; &lt;fct&gt;          &lt;dbl&gt;   &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;
1    0.84       0.16  pos                6     148       72      35       0
2    0.179      0.821 neg                1      85       66      29       0
3    0.278      0.722 neg                8     183       64       0       0
4    0.0385     0.962 neg                5     116       74       0       0
5    0.278      0.722 neg               10     139       80       0       0
6    0.692      0.308 pos                5     166       72      19     175
# ℹ 4 more variables: mass &lt;dbl&gt;, pedigree &lt;dbl&gt;, age &lt;dbl&gt;, diabetes &lt;fct&gt;</code></pre>
</div>
</div>
</section><section id="confusion-matrices-and-metrics" class="level4"><h4 class="anchored" data-anchor-id="confusion-matrices-and-metrics">4.3 Confusion matrices and metrics</h4>
<p>We can use <code>yardstick</code> metrics (tidymodels) instead of <code><a href="https://rdrr.io/pkg/caret/man/confusionMatrix.html">caret::confusionMatrix</a></code>.</p>
<div class="cell">
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">class_metrics</span> <span class="op">&lt;-</span> <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span></span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span>,</span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/precision.html">precision</a></span>,</span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/recall.html">recall</a></span>,</span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/sens.html">sens</a></span>,</span>
<span>  <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/spec.html">specificity</a></span></span>
<span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Training performance:</p>
<div class="cell">
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_conf_basic</span> <span class="op">&lt;-</span> <span class="fu">conf_mat</span><span class="op">(</span><span class="va">train_preds_basic</span>,</span>
<span>                             truth <span class="op">=</span> <span class="va">diabetes</span>,</span>
<span>                             estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="va">train_conf_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction pos neg
       pos 134  22
       neg  53 328</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_metrics_basic</span> <span class="op">&lt;-</span> <span class="va">train_preds_basic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_metrics_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.860
2 precision   binary         0.859
3 recall      binary         0.717
4 sens        binary         0.717
5 specificity binary         0.937</code></pre>
</div>
</div>
<p>Testing performance:</p>
<div class="cell">
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_conf_basic</span> <span class="op">&lt;-</span> <span class="fu">conf_mat</span><span class="op">(</span><span class="va">test_preds_basic</span>,</span>
<span>                            truth <span class="op">=</span> <span class="va">diabetes</span>,</span>
<span>                            estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span><span class="va">test_conf_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Truth
Prediction pos neg
       pos  44  18
       neg  37 132</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_metrics_basic</span> <span class="op">&lt;-</span> <span class="va">test_preds_basic</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_metrics_basic</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.762
2 precision   binary         0.710
3 recall      binary         0.543
4 sens        binary         0.543
5 specificity binary         0.88 </code></pre>
</div>
</div>
<p>As expected, <strong>training accuracy is higher than testing accuracy</strong> → the tree is starting to <strong>overfit</strong> the training data.</p>
<hr></section></section></section><section id="hyperparameters-manual-change" class="level2"><h2 class="anchored" data-anchor-id="hyperparameters-manual-change">Hyperparameters (manual change)</h2>
<p>Decision trees have several <strong>stopping criteria</strong> (hyperparameters) that control complexity and help reduce overfitting. In tidymodels these are, for example:</p>
<ul>
<li>
<code>tree_depth</code> – maximum depth of the tree<br>
</li>
<li>
<code>min_n</code> – minimum number of samples in a terminal node<br>
</li>
<li>
<code>cost_complexity</code> – complexity parameter (cp) for pruning</li>
</ul>
<p>We can manually set some of these and see the effect.</p>
<div class="cell">
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_spec_shallow</span> <span class="op">&lt;-</span> <span class="fu">decision_tree</span><span class="op">(</span></span>
<span>  tree_depth <span class="op">=</span> <span class="fl">3</span>,</span>
<span>  min_n <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"rpart"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_wf_shallow</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">tree_spec_shallow</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_fit_shallow</span> <span class="op">&lt;-</span> <span class="va">tree_wf_shallow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_fit_shallow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span>extra <span class="op">=</span> <span class="fl">101</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot retrieve the data used to build the model (so cannot determine roundint and is.binary for the variables).
To silence this warning:
    Call rpart.plot with roundint=FALSE,
    or rebuild the rpart model with model=TRUE.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="DecisionTree_tidymodels_section_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<section id="evaluate-the-shallow-tree" class="level3"><h3 class="anchored" data-anchor-id="evaluate-the-shallow-tree">Evaluate the shallow tree</h3>
<div class="cell">
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_preds_shallow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_shallow</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_shallow</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_preds_shallow</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_shallow</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">tree_fit_shallow</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_metrics_shallow</span> <span class="op">&lt;-</span> <span class="va">train_preds_shallow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_metrics_shallow</span> <span class="op">&lt;-</span> <span class="va">test_preds_shallow</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_metrics_shallow</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.771
2 precision   binary         0.725
3 recall      binary         0.551
4 sens        binary         0.551
5 specificity binary         0.889</code></pre>
</div>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_metrics_shallow</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.775
2 precision   binary         0.723
3 recall      binary         0.580
4 sens        binary         0.580
5 specificity binary         0.88 </code></pre>
</div>
</div>
<p>You should see:</p>
<ul>
<li>Training accuracy <strong>drops</strong> (the model is simpler),<br>
</li>
<li>Testing accuracy is often <strong>closer to training</strong>, indicating <strong>better generalisation</strong> and less overfitting.</li>
</ul>
<p>You can manually try other values of <code>tree_depth</code> and <code>min_n</code> and observe the effect.</p>
<hr></section></section><section id="hyperparameter-tuning-with-tidymodels" class="level2"><h2 class="anchored" data-anchor-id="hyperparameter-tuning-with-tidymodels">Hyperparameter tuning with tidymodels</h2>
<p>Instead of trying values one-by-one, we can <strong>systematically search</strong> over a grid of hyperparameters using grid search. For more details: <a href="https://www.tmwr.org/grid-search" class="uri">https://www.tmwr.org/grid-search</a></p>
<section id="create-a-tunable-tree-specification" class="level3"><h3 class="anchored" data-anchor-id="create-a-tunable-tree-specification">1. Create a tunable tree specification</h3>
<div class="cell">
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_spec_tune</span> <span class="op">&lt;-</span> <span class="fu">decision_tree</span><span class="op">(</span></span>
<span>  tree_depth <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span>,</span>
<span>  min_n      <span class="op">=</span> <span class="fu">tune</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"rpart"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_spec_tune</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Decision Tree Model Specification (classification)

Main Arguments:
  tree_depth = tune()
  min_n = tune()

Computational engine: rpart </code></pre>
</div>
</div>
<p>Which parameters to try? There are default parameters that you can check associated to the model libraries <a href="https://dials.tidymodels.org/articles/Basics.html" class="uri">https://dials.tidymodels.org/articles/Basics.html</a> For example we could create models with these range of values and see which ones works best:</p>
</section><section id="define-a-tuning-grid" class="level3"><h3 class="anchored" data-anchor-id="define-a-tuning-grid">3. Define a tuning grid</h3>
<div class="cell">
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_grid</span> <span class="op">&lt;-</span> <span class="fu">grid_regular</span><span class="op">(</span></span>
<span>  <span class="fu">tree_depth</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1L</span>, <span class="fl">10L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">min_n</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2L</span>, <span class="fl">30L</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  levels <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_grid</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 2
   tree_depth min_n
        &lt;int&gt; &lt;int&gt;
 1          1     2
 2          3     2
 3          5     2
 4          7     2
 5         10     2
 6          1     9
 7          3     9
 8          5     9
 9          7     9
10         10     9
# ℹ 15 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_wf_cv</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">tree_spec_tune</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section><section id="run-tune_grid" class="level3"><h3 class="anchored" data-anchor-id="run-tune_grid">4. Run <code>tune_grid()</code>
</h3>
<p>For each combination in the grid, tidymodels fits a model and calculates accuracy and ROC AUC (metrics of choice for classification). We will see on Friday (and you saw yesterday) that the proper way of doing this is through cross-validation. Why is this needed? Because a single train/test split can give a lucky (or unlucky) result. Cross-validation gives a stable estimate of performance for each hyperparameter setting. But lets go one step at a time.</p>
<div class="cell">
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">tree_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">tree_wf_cv</span>,</span>
<span>  resamples <span class="op">=</span> <span class="fu">bootstraps</span><span class="op">(</span><span class="va">train_data</span>, times <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, <span class="co">#normally would have your crossvalidation info here - something like this (pima_folds &lt;- vfold_cv(train_data, v = 5)) - but will learn about this later on.</span></span>
<span>  grid      <span class="op">=</span> <span class="va">tree_grid</span>,</span>
<span>  metrics   <span class="op">=</span> <span class="fu">yardstick</span><span class="fu">::</span><span class="fu"><a href="https://yardstick.tidymodels.org/reference/metric_set.html">metric_set</a></span><span class="op">(</span><span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/roc_auc.html">roc_auc</a></span>, <span class="fu">yardstick</span><span class="fu">::</span><span class="va"><a href="https://yardstick.tidymodels.org/reference/accuracy.html">accuracy</a></span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_res</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># Tuning results
# Bootstrap sampling 
# A tibble: 1 × 4
  splits            id         .metrics          .notes          
  &lt;list&gt;            &lt;chr&gt;      &lt;list&gt;            &lt;list&gt;          
1 &lt;split [537/191]&gt; Bootstrap1 &lt;tibble [50 × 6]&gt; &lt;tibble [0 × 4]&gt;</code></pre>
</div>
</div>
<p>Inspect the best results (e.g.&nbsp;by ROC AUC):</p>
<div class="cell">
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">show_best</span><span class="op">(</span><span class="va">tree_res</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span>, n <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 8
  tree_depth min_n .metric .estimator  mean     n std_err .config         
       &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;           
1          7    30 roc_auc binary     0.742     1      NA pre0_mod20_post0
2         10    30 roc_auc binary     0.742     1      NA pre0_mod25_post0
3          3     2 roc_auc binary     0.734     1      NA pre0_mod06_post0
4          3     9 roc_auc binary     0.734     1      NA pre0_mod07_post0
5          3    16 roc_auc binary     0.734     1      NA pre0_mod08_post0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">tree_metrics</span> <span class="op">&lt;-</span> <span class="fu">collect_metrics</span><span class="op">(</span><span class="va">tree_res</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_metrics</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 25 × 8
   tree_depth min_n .metric .estimator  mean     n std_err .config         
        &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;           
 1          1     2 roc_auc binary     0.730     1      NA pre0_mod01_post0
 2          1     9 roc_auc binary     0.730     1      NA pre0_mod02_post0
 3          1    16 roc_auc binary     0.730     1      NA pre0_mod03_post0
 4          1    23 roc_auc binary     0.730     1      NA pre0_mod04_post0
 5          1    30 roc_auc binary     0.730     1      NA pre0_mod05_post0
 6          3     2 roc_auc binary     0.734     1      NA pre0_mod06_post0
 7          3     9 roc_auc binary     0.734     1      NA pre0_mod07_post0
 8          3    16 roc_auc binary     0.734     1      NA pre0_mod08_post0
 9          3    23 roc_auc binary     0.733     1      NA pre0_mod09_post0
10          3    30 roc_auc binary     0.725     1      NA pre0_mod10_post0
# ℹ 15 more rows</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="va">tree_res</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="DecisionTree_tidymodels_section_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Select the best hyperparameters and finalise the workflow:</p>
<div class="cell">
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">best_tree</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">tree_res</span>, metric <span class="op">=</span> <span class="st">"roc_auc"</span><span class="op">)</span></span>
<span><span class="va">best_tree</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  tree_depth min_n .config         
       &lt;int&gt; &lt;int&gt; &lt;chr&gt;           
1          7    30 pre0_mod20_post0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">final_tree_wf</span> <span class="op">&lt;-</span> <span class="fu">finalize_workflow</span><span class="op">(</span><span class="va">tree_wf_cv</span>, <span class="va">best_tree</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_tree_fit</span> <span class="op">&lt;-</span> <span class="va">final_tree_wf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">fit</span><span class="op">(</span>data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_tree_fit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>══ Workflow [trained] ══════════════════════════════════════════════════════════
Preprocessor: Recipe
Model: decision_tree()

── Preprocessor ────────────────────────────────────────────────────────────────
0 Recipe Steps

── Model ───────────────────────────────────────────────────────────────────────
n= 537 

node), split, n, loss, yval, (yprob)
      * denotes terminal node

  1) root 537 187 neg (0.34823091 0.65176909)  
    2) glucose&gt;=127.5 189  71 pos (0.62433862 0.37566138)  
      4) mass&gt;=29.95 142  39 pos (0.72535211 0.27464789)  
        8) glucose&gt;=157.5 62   6 pos (0.90322581 0.09677419) *
        9) glucose&lt; 157.5 80  33 pos (0.58750000 0.41250000)  
         18) pressure&lt; 61 12   0 pos (1.00000000 0.00000000) *
         19) pressure&gt;=61 68  33 pos (0.51470588 0.48529412)  
           38) age&gt;=30.5 42  14 pos (0.66666667 0.33333333)  
             76) pedigree&gt;=0.415 25   4 pos (0.84000000 0.16000000) *
             77) pedigree&lt; 0.415 17   7 neg (0.41176471 0.58823529) *
           39) age&lt; 30.5 26   7 neg (0.26923077 0.73076923) *
      5) mass&lt; 29.95 47  15 neg (0.31914894 0.68085106)  
       10) age&gt;=27.5 31  14 neg (0.45161290 0.54838710)  
         20) insulin&gt;=69.5 13   4 pos (0.69230769 0.30769231) *
         21) insulin&lt; 69.5 18   5 neg (0.27777778 0.72222222) *
       11) age&lt; 27.5 16   1 neg (0.06250000 0.93750000) *
    3) glucose&lt; 127.5 348  69 neg (0.19827586 0.80172414)  
      6) age&gt;=28.5 154  53 neg (0.34415584 0.65584416)  
       12) mass&gt;=26.35 128  52 neg (0.40625000 0.59375000)  
         24) pedigree&gt;=0.561 35  12 pos (0.65714286 0.34285714)  
           48) glucose&gt;=101 23   5 pos (0.78260870 0.21739130) *
           49) glucose&lt; 101 12   5 neg (0.41666667 0.58333333) *
         25) pedigree&lt; 0.561 93  29 neg (0.31182796 0.68817204)  
           50) triceps&lt; 27.5 54  22 neg (0.40740741 0.59259259)  
            100) glucose&gt;=93.5 44  22 pos (0.50000000 0.50000000)  
              200) pressure&lt; 74.5 25   9 pos (0.64000000 0.36000000) *
              201) pressure&gt;=74.5 19   6 neg (0.31578947 0.68421053) *
            101) glucose&lt; 93.5 10   0 neg (0.00000000 1.00000000) *
           51) triceps&gt;=27.5 39   7 neg (0.17948718 0.82051282) *
       13) mass&lt; 26.35 26   1 neg (0.03846154 0.96153846) *
      7) age&lt; 28.5 194  16 neg (0.08247423 0.91752577) *</code></pre>
</div>
</div>
</section><section id="evaluate-the-tuned-tree-on-the-test-set" class="level3"><h3 class="anchored" data-anchor-id="evaluate-the-tuned-tree-on-the-test-set">5. Evaluate the tuned tree on the test set</h3>
<div class="cell">
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_preds_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_tree_fit</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_tree_fit</span>, <span class="va">train_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_preds_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_tree_fit</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"prob"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_tree_fit</span>, <span class="va">test_data</span>, type <span class="op">=</span> <span class="st">"class"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">train_metrics_final</span> <span class="op">&lt;-</span> <span class="va">train_preds_final</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">test_metrics_final</span> <span class="op">&lt;-</span> <span class="va">test_preds_final</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">class_metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">diabetes</span>, estimate <span class="op">=</span> <span class="va">.pred_class</span><span class="op">)</span></span>
<span></span>
<span><span class="va">train_metrics_final</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.845
2 precision   binary         0.825
3 recall      binary         0.706
4 sens        binary         0.706
5 specificity binary         0.92 </code></pre>
</div>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">test_metrics_final</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 3
  .metric     .estimator .estimate
  &lt;chr&gt;       &lt;chr&gt;          &lt;dbl&gt;
1 accuracy    binary         0.762
2 precision   binary         0.703
3 recall      binary         0.556
4 sens        binary         0.556
5 specificity binary         0.873</code></pre>
</div>
</div>
<p>We can also compare ROC AUC:</p>
<div class="cell">
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">roc_auc</span><span class="op">(</span><span class="va">train_preds_final</span>, truth <span class="op">=</span> <span class="va">diabetes</span>, <span class="va">.pred_pos</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.886</code></pre>
</div>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="fu">roc_auc</span><span class="op">(</span><span class="va">test_preds_final</span>,  truth <span class="op">=</span> <span class="va">diabetes</span>, <span class="va">.pred_pos</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  .metric .estimator .estimate
  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
1 roc_auc binary         0.816</code></pre>
</div>
</div>
<p>And visualise the final tree:</p>
<div class="cell">
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r code-with-copy"><code class="sourceCode R"><span><span class="va">final_tree_fit</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">extract_fit_parsnip</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="st">"fit"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/rpart.plot/man/rpart.plot.html">rpart.plot</a></span><span class="op">(</span>extra <span class="op">=</span> <span class="fl">101</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Cannot retrieve the data used to build the model (so cannot determine roundint and is.binary for the variables).
To silence this warning:
    Call rpart.plot with roundint=FALSE,
    or rebuild the rpart model with model=TRUE.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure"><p><img src="DecisionTree_tidymodels_section_files/figure-html/unnamed-chunk-29-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<hr></section><section id="key-messages" class="level3"><h3 class="anchored" data-anchor-id="key-messages">Key messages</h3>
<ul>
<li>A <strong>basic tree</strong> can easily overfit: high training accuracy, lower test accuracy.<br>
</li>
<li>
<strong>Hyperparameters</strong> like <code>tree_depth</code> and <code>min_n</code> control complexity and help reduce overfitting.<br>
</li>
<li>
<strong>tidymodels</strong> lets us:
<ul>
<li>define tunable specifications (<code>tune()</code>),</li>
<li>keep preprocessing and modelling together in <strong>workflows</strong>,</li>
<li>and only evaluate on the <strong>test set once</strong> at the very end.</li>
</ul>
</li>
</ul>
<p>Remember:<br>
&gt; Hyperparameter tuning is part of the training process.<br>
&gt; The <strong>test set must never be used</strong> to choose hyperparameters – only to evaluate the final chosen model.</p>


<!-- -->

</section></section><a onclick="window.scrollTo(0, 0); return false;" role="button" id="quarto-back-to-top"><i class="bi bi-arrow-up"></i> Back to top</a></main><!-- /main --><script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
    const viewSource = window.document.getElementById('quarto-view-source') ||
                       window.document.getElementById('quarto-code-tools-source');
    if (viewSource) {
      const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
      viewSource.addEventListener("click", function(e) {
        if (sourceUrl) {
          // rstudio viewer pane
          if (/\bcapabilities=\b/.test(window.location)) {
            window.open(sourceUrl);
          } else {
            window.location.href = sourceUrl;
          }
        } else {
          const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
          modal.show();
        }
        return false;
      });
    }
    function toggleCodeHandler(show) {
      return function(e) {
        const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
        for (let i=0; i<detailsSrc.length; i++) {
          const details = detailsSrc[i].parentElement;
          if (show) {
            details.open = true;
          } else {
            details.removeAttribute("open");
          }
        }
        const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
        const fromCls = show ? "hidden" : "unhidden";
        const toCls = show ? "unhidden" : "hidden";
        for (let i=0; i<cellCodeDivs.length; i++) {
          const codeDiv = cellCodeDivs[i];
          if (codeDiv.classList.contains(fromCls)) {
            codeDiv.classList.remove(fromCls);
            codeDiv.classList.add(toCls);
          } 
        }
        return false;
      }
    }
    const hideAllCode = window.document.getElementById("quarto-hide-all-code");
    if (hideAllCode) {
      hideAllCode.addEventListener("click", toggleCodeHandler(false));
    }
    const showAllCode = window.document.getElementById("quarto-show-all-code");
    if (showAllCode) {
      showAllCode.addEventListener("click", toggleCodeHandler(true));
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script><nav class="page-navigation"><div class="nav-page nav-page-previous">
      <a href="./Classification_Performance_tidymodels_ROC.html" class="pagination-link" aria-label="Evaluate Performance in Classification (tidymodels)">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Evaluate Performance in Classification (tidymodels)</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./random_forest_tidymodels_exercise.html" class="pagination-link" aria-label="Random Forest Classification (tidymodels)">
        <span class="nav-page-text">Random Forest Classification (tidymodels)</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav><div class="modal fade" id="quarto-embedded-source-code-modal" tabindex="-1" aria-labelledby="quarto-embedded-source-code-modal-label" aria-hidden="true"><div class="modal-dialog modal-dialog-scrollable"><div class="modal-content"><div class="modal-header"><h5 class="modal-title" id="quarto-embedded-source-code-modal-label">Source Code</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="">
<div class="sourceCode" id="cb65" data-shortcodes="false"><pre class="sourceCode markdown code-with-copy"><code class="sourceCode markdown"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="an">title:</span><span class="co"> "Decision Trees in Classification (tidymodels)"</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="an">format:</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">  html:</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a><span class="co">    toc: true</span></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a><span class="co"> #   code-fold: true</span></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co">---</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a><span class="fu">## Fitting a classification decision tree (tidymodels)</span></span>
<span id="cb65-11"><a href="#cb65-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-12"><a href="#cb65-12" aria-hidden="true" tabindex="-1"></a><span class="in">```{r, message=FALSE}</span></span>
<span id="cb65-13"><a href="#cb65-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Load libraries</span></span>
<span id="cb65-14"><a href="#cb65-14" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidymodels)</span>
<span id="cb65-15"><a href="#cb65-15" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(mlbench)</span>
<span id="cb65-16"><a href="#cb65-16" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb65-17"><a href="#cb65-17" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rpart.plot)   <span class="co"># for plotting the fitted rpart tree</span></span>
<span id="cb65-18"><a href="#cb65-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-19"><a href="#cb65-19" aria-hidden="true" tabindex="-1"></a><span class="fu">theme_set</span>(<span class="fu">theme_bw</span>())</span>
<span id="cb65-20"><a href="#cb65-20" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb65-21"><a href="#cb65-21" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-22"><a href="#cb65-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-23"><a href="#cb65-23" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Data preparation and split</span></span>
<span id="cb65-24"><a href="#cb65-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-27"><a href="#cb65-27" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-28"><a href="#cb65-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Load the dataset and inspect</span></span>
<span id="cb65-29"><a href="#cb65-29" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(<span class="st">"PimaIndiansDiabetes"</span>)</span>
<span id="cb65-30"><a href="#cb65-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-31"><a href="#cb65-31" aria-hidden="true" tabindex="-1"></a>pima <span class="ot">&lt;-</span> PimaIndiansDiabetes <span class="sc">%&gt;%</span></span>
<span id="cb65-32"><a href="#cb65-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-33"><a href="#cb65-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb65-34"><a href="#cb65-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">diabetes =</span> <span class="fu">factor</span>(diabetes),</span>
<span id="cb65-35"><a href="#cb65-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">diabetes =</span> forcats<span class="sc">::</span><span class="fu">fct_relevel</span>(diabetes, <span class="st">"pos"</span>, <span class="st">"neg"</span>) <span class="co"># make 'pos' the event</span></span>
<span id="cb65-36"><a href="#cb65-36" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb65-37"><a href="#cb65-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-38"><a href="#cb65-38" aria-hidden="true" tabindex="-1"></a><span class="fu">levels</span>(pima<span class="sc">$</span>diabetes)</span>
<span id="cb65-39"><a href="#cb65-39" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(pima)</span>
<span id="cb65-40"><a href="#cb65-40" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-41"><a href="#cb65-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-42"><a href="#cb65-42" aria-hidden="true" tabindex="-1"></a>We split into **training** and **testing** datasets (70/30), stratifying by the outcome:</span>
<span id="cb65-43"><a href="#cb65-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-46"><a href="#cb65-46" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-47"><a href="#cb65-47" aria-hidden="true" tabindex="-1"></a>data_split <span class="ot">&lt;-</span> <span class="fu">initial_split</span>(pima, <span class="at">prop =</span> <span class="fl">0.7</span>, <span class="at">strata =</span> diabetes)</span>
<span id="cb65-48"><a href="#cb65-48" aria-hidden="true" tabindex="-1"></a>train_data <span class="ot">&lt;-</span> <span class="fu">training</span>(data_split)</span>
<span id="cb65-49"><a href="#cb65-49" aria-hidden="true" tabindex="-1"></a>test_data  <span class="ot">&lt;-</span> <span class="fu">testing</span>(data_split)</span>
<span id="cb65-50"><a href="#cb65-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-51"><a href="#cb65-51" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(pima)</span>
<span id="cb65-52"><a href="#cb65-52" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(train_data)</span>
<span id="cb65-53"><a href="#cb65-53" aria-hidden="true" tabindex="-1"></a><span class="fu">dim</span>(test_data)</span>
<span id="cb65-54"><a href="#cb65-54" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-55"><a href="#cb65-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-56"><a href="#cb65-56" aria-hidden="true" tabindex="-1"></a><span class="fu">### 2. Basic decision tree (no tuning)</span></span>
<span id="cb65-57"><a href="#cb65-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-58"><a href="#cb65-58" aria-hidden="true" tabindex="-1"></a>We start with a very simple tree model using **all predictors**.</span>
<span id="cb65-59"><a href="#cb65-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-62"><a href="#cb65-62" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-63"><a href="#cb65-63" aria-hidden="true" tabindex="-1"></a><span class="co"># Model specification: basic classification tree</span></span>
<span id="cb65-64"><a href="#cb65-64" aria-hidden="true" tabindex="-1"></a>tree_spec_basic <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-65"><a href="#cb65-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-66"><a href="#cb65-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb65-67"><a href="#cb65-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-68"><a href="#cb65-68" aria-hidden="true" tabindex="-1"></a><span class="co"># Recipe: use all predictors as-is</span></span>
<span id="cb65-69"><a href="#cb65-69" aria-hidden="true" tabindex="-1"></a>tree_rec <span class="ot">&lt;-</span> <span class="fu">recipe</span>(diabetes <span class="sc">~</span> ., <span class="at">data =</span> train_data)</span>
<span id="cb65-70"><a href="#cb65-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-71"><a href="#cb65-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Workflow: model + recipe</span></span>
<span id="cb65-72"><a href="#cb65-72" aria-hidden="true" tabindex="-1"></a>tree_wf_basic <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-73"><a href="#cb65-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tree_spec_basic) <span class="sc">%&gt;%</span></span>
<span id="cb65-74"><a href="#cb65-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tree_rec)</span>
<span id="cb65-75"><a href="#cb65-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-76"><a href="#cb65-76" aria-hidden="true" tabindex="-1"></a>tree_wf_basic</span>
<span id="cb65-77"><a href="#cb65-77" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-78"><a href="#cb65-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-79"><a href="#cb65-79" aria-hidden="true" tabindex="-1"></a>Fit the workflow on the **training set**:</span>
<span id="cb65-80"><a href="#cb65-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-83"><a href="#cb65-83" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-84"><a href="#cb65-84" aria-hidden="true" tabindex="-1"></a>tree_fit_basic <span class="ot">&lt;-</span> tree_wf_basic <span class="sc">%&gt;%</span></span>
<span id="cb65-85"><a href="#cb65-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> train_data)</span>
<span id="cb65-86"><a href="#cb65-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-87"><a href="#cb65-87" aria-hidden="true" tabindex="-1"></a>tree_fit_basic</span>
<span id="cb65-88"><a href="#cb65-88" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-89"><a href="#cb65-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-90"><a href="#cb65-90" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Visualise the basic tree</span></span>
<span id="cb65-91"><a href="#cb65-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-92"><a href="#cb65-92" aria-hidden="true" tabindex="-1"></a>We can extract the underlying <span class="in">`rpart`</span> object and use <span class="in">`rpart.plot()`</span>:</span>
<span id="cb65-93"><a href="#cb65-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-96"><a href="#cb65-96" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-97"><a href="#cb65-97" aria-hidden="true" tabindex="-1"></a>tree_fit_basic <span class="sc">%&gt;%</span></span>
<span id="cb65-98"><a href="#cb65-98" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-99"><a href="#cb65-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"fit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-100"><a href="#cb65-100" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">extra =</span> <span class="dv">101</span>)</span>
<span id="cb65-101"><a href="#cb65-101" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-102"><a href="#cb65-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-103"><a href="#cb65-103" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb65-104"><a href="#cb65-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-105"><a href="#cb65-105" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. Predictions and performance (basic tree)</span></span>
<span id="cb65-106"><a href="#cb65-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-107"><a href="#cb65-107" aria-hidden="true" tabindex="-1"></a>We now evaluate performance on **train** and **test** data.</span>
<span id="cb65-108"><a href="#cb65-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-109"><a href="#cb65-109" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.1 Training predictions</span></span>
<span id="cb65-110"><a href="#cb65-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-113"><a href="#cb65-113" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-114"><a href="#cb65-114" aria-hidden="true" tabindex="-1"></a>train_preds_basic <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit_basic, train_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-115"><a href="#cb65-115" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(tree_fit_basic, train_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-116"><a href="#cb65-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(train_data)</span>
<span id="cb65-117"><a href="#cb65-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-118"><a href="#cb65-118" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(train_preds_basic)</span>
<span id="cb65-119"><a href="#cb65-119" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-120"><a href="#cb65-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-121"><a href="#cb65-121" aria-hidden="true" tabindex="-1"></a>The <span class="in">`.pred_pos`</span> column contains the estimated probability of <span class="in">`"pos"`</span> (diabetes present), and <span class="in">`.pred_class`</span> is the predicted class using the default threshold 0.5.</span>
<span id="cb65-122"><a href="#cb65-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-123"><a href="#cb65-123" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.2 Testing predictions</span></span>
<span id="cb65-124"><a href="#cb65-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-127"><a href="#cb65-127" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-128"><a href="#cb65-128" aria-hidden="true" tabindex="-1"></a>test_preds_basic <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit_basic, test_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-129"><a href="#cb65-129" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(tree_fit_basic, test_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-130"><a href="#cb65-130" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data)</span>
<span id="cb65-131"><a href="#cb65-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-132"><a href="#cb65-132" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(test_preds_basic)</span>
<span id="cb65-133"><a href="#cb65-133" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-134"><a href="#cb65-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-135"><a href="#cb65-135" aria-hidden="true" tabindex="-1"></a><span class="fu">#### 4.3 Confusion matrices and metrics</span></span>
<span id="cb65-136"><a href="#cb65-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-137"><a href="#cb65-137" aria-hidden="true" tabindex="-1"></a>We can use <span class="in">`yardstick`</span> metrics (tidymodels) instead of <span class="in">`caret::confusionMatrix`</span>.</span>
<span id="cb65-138"><a href="#cb65-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-141"><a href="#cb65-141" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-142"><a href="#cb65-142" aria-hidden="true" tabindex="-1"></a>class_metrics <span class="ot">&lt;-</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(</span>
<span id="cb65-143"><a href="#cb65-143" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>accuracy,</span>
<span id="cb65-144"><a href="#cb65-144" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>precision,</span>
<span id="cb65-145"><a href="#cb65-145" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>recall,</span>
<span id="cb65-146"><a href="#cb65-146" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>sens,</span>
<span id="cb65-147"><a href="#cb65-147" aria-hidden="true" tabindex="-1"></a>  yardstick<span class="sc">::</span>specificity</span>
<span id="cb65-148"><a href="#cb65-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-149"><a href="#cb65-149" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-150"><a href="#cb65-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-151"><a href="#cb65-151" aria-hidden="true" tabindex="-1"></a>Training performance:</span>
<span id="cb65-152"><a href="#cb65-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-155"><a href="#cb65-155" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-156"><a href="#cb65-156" aria-hidden="true" tabindex="-1"></a>train_conf_basic <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(train_preds_basic,</span>
<span id="cb65-157"><a href="#cb65-157" aria-hidden="true" tabindex="-1"></a>                             <span class="at">truth =</span> diabetes,</span>
<span id="cb65-158"><a href="#cb65-158" aria-hidden="true" tabindex="-1"></a>                             <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-159"><a href="#cb65-159" aria-hidden="true" tabindex="-1"></a>train_conf_basic</span>
<span id="cb65-160"><a href="#cb65-160" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-161"><a href="#cb65-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-164"><a href="#cb65-164" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-165"><a href="#cb65-165" aria-hidden="true" tabindex="-1"></a>train_metrics_basic <span class="ot">&lt;-</span> train_preds_basic <span class="sc">%&gt;%</span></span>
<span id="cb65-166"><a href="#cb65-166" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-167"><a href="#cb65-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-168"><a href="#cb65-168" aria-hidden="true" tabindex="-1"></a>train_metrics_basic</span>
<span id="cb65-169"><a href="#cb65-169" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-170"><a href="#cb65-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-171"><a href="#cb65-171" aria-hidden="true" tabindex="-1"></a>Testing performance:</span>
<span id="cb65-172"><a href="#cb65-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-175"><a href="#cb65-175" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-176"><a href="#cb65-176" aria-hidden="true" tabindex="-1"></a>test_conf_basic <span class="ot">&lt;-</span> <span class="fu">conf_mat</span>(test_preds_basic,</span>
<span id="cb65-177"><a href="#cb65-177" aria-hidden="true" tabindex="-1"></a>                            <span class="at">truth =</span> diabetes,</span>
<span id="cb65-178"><a href="#cb65-178" aria-hidden="true" tabindex="-1"></a>                            <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-179"><a href="#cb65-179" aria-hidden="true" tabindex="-1"></a>test_conf_basic</span>
<span id="cb65-180"><a href="#cb65-180" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-181"><a href="#cb65-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-184"><a href="#cb65-184" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-185"><a href="#cb65-185" aria-hidden="true" tabindex="-1"></a>test_metrics_basic <span class="ot">&lt;-</span> test_preds_basic <span class="sc">%&gt;%</span></span>
<span id="cb65-186"><a href="#cb65-186" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-187"><a href="#cb65-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-188"><a href="#cb65-188" aria-hidden="true" tabindex="-1"></a>test_metrics_basic</span>
<span id="cb65-189"><a href="#cb65-189" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-190"><a href="#cb65-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-191"><a href="#cb65-191" aria-hidden="true" tabindex="-1"></a>As expected, **training accuracy is higher than testing accuracy** → the tree is starting to **overfit** the training data.</span>
<span id="cb65-192"><a href="#cb65-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-193"><a href="#cb65-193" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb65-194"><a href="#cb65-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-195"><a href="#cb65-195" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyperparameters (manual change)</span></span>
<span id="cb65-196"><a href="#cb65-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-197"><a href="#cb65-197" aria-hidden="true" tabindex="-1"></a>Decision trees have several **stopping criteria** (hyperparameters) that control complexity and help reduce overfitting. In tidymodels these are, for example:</span>
<span id="cb65-198"><a href="#cb65-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-199"><a href="#cb65-199" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`tree_depth`</span> – maximum depth of the tree  </span>
<span id="cb65-200"><a href="#cb65-200" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`min_n`</span> – minimum number of samples in a terminal node  </span>
<span id="cb65-201"><a href="#cb65-201" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span><span class="in">`cost_complexity`</span> – complexity parameter (cp) for pruning  </span>
<span id="cb65-202"><a href="#cb65-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-203"><a href="#cb65-203" aria-hidden="true" tabindex="-1"></a>We can manually set some of these and see the effect.</span>
<span id="cb65-204"><a href="#cb65-204" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-207"><a href="#cb65-207" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-208"><a href="#cb65-208" aria-hidden="true" tabindex="-1"></a>tree_spec_shallow <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(</span>
<span id="cb65-209"><a href="#cb65-209" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="dv">3</span>,</span>
<span id="cb65-210"><a href="#cb65-210" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n =</span> <span class="dv">20</span></span>
<span id="cb65-211"><a href="#cb65-211" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb65-212"><a href="#cb65-212" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-213"><a href="#cb65-213" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb65-214"><a href="#cb65-214" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-215"><a href="#cb65-215" aria-hidden="true" tabindex="-1"></a>tree_wf_shallow <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-216"><a href="#cb65-216" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tree_spec_shallow) <span class="sc">%&gt;%</span></span>
<span id="cb65-217"><a href="#cb65-217" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tree_rec)</span>
<span id="cb65-218"><a href="#cb65-218" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-219"><a href="#cb65-219" aria-hidden="true" tabindex="-1"></a>tree_fit_shallow <span class="ot">&lt;-</span> tree_wf_shallow <span class="sc">%&gt;%</span></span>
<span id="cb65-220"><a href="#cb65-220" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> train_data)</span>
<span id="cb65-221"><a href="#cb65-221" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-222"><a href="#cb65-222" aria-hidden="true" tabindex="-1"></a>tree_fit_shallow <span class="sc">%&gt;%</span></span>
<span id="cb65-223"><a href="#cb65-223" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-224"><a href="#cb65-224" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"fit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-225"><a href="#cb65-225" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">extra =</span> <span class="dv">101</span>)</span>
<span id="cb65-226"><a href="#cb65-226" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-227"><a href="#cb65-227" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-228"><a href="#cb65-228" aria-hidden="true" tabindex="-1"></a><span class="fu">### Evaluate the shallow tree</span></span>
<span id="cb65-229"><a href="#cb65-229" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-232"><a href="#cb65-232" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-233"><a href="#cb65-233" aria-hidden="true" tabindex="-1"></a>train_preds_shallow <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit_shallow, train_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-234"><a href="#cb65-234" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(tree_fit_shallow, train_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-235"><a href="#cb65-235" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(train_data)</span>
<span id="cb65-236"><a href="#cb65-236" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-237"><a href="#cb65-237" aria-hidden="true" tabindex="-1"></a>test_preds_shallow <span class="ot">&lt;-</span> <span class="fu">predict</span>(tree_fit_shallow, test_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-238"><a href="#cb65-238" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(tree_fit_shallow, test_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-239"><a href="#cb65-239" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data)</span>
<span id="cb65-240"><a href="#cb65-240" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-241"><a href="#cb65-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-244"><a href="#cb65-244" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-245"><a href="#cb65-245" aria-hidden="true" tabindex="-1"></a>train_metrics_shallow <span class="ot">&lt;-</span> train_preds_shallow <span class="sc">%&gt;%</span></span>
<span id="cb65-246"><a href="#cb65-246" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-247"><a href="#cb65-247" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-248"><a href="#cb65-248" aria-hidden="true" tabindex="-1"></a>test_metrics_shallow <span class="ot">&lt;-</span> test_preds_shallow <span class="sc">%&gt;%</span></span>
<span id="cb65-249"><a href="#cb65-249" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-250"><a href="#cb65-250" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-251"><a href="#cb65-251" aria-hidden="true" tabindex="-1"></a>train_metrics_shallow</span>
<span id="cb65-252"><a href="#cb65-252" aria-hidden="true" tabindex="-1"></a>test_metrics_shallow</span>
<span id="cb65-253"><a href="#cb65-253" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-254"><a href="#cb65-254" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-255"><a href="#cb65-255" aria-hidden="true" tabindex="-1"></a>You should see:</span>
<span id="cb65-256"><a href="#cb65-256" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-257"><a href="#cb65-257" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Training accuracy **drops** (the model is simpler),  </span>
<span id="cb65-258"><a href="#cb65-258" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>Testing accuracy is often **closer to training**, indicating **better generalisation** and less overfitting.</span>
<span id="cb65-259"><a href="#cb65-259" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-260"><a href="#cb65-260" aria-hidden="true" tabindex="-1"></a>You can manually try other values of <span class="in">`tree_depth`</span> and <span class="in">`min_n`</span> and observe the effect.</span>
<span id="cb65-261"><a href="#cb65-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-262"><a href="#cb65-262" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb65-263"><a href="#cb65-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-264"><a href="#cb65-264" aria-hidden="true" tabindex="-1"></a><span class="fu">## Hyperparameter tuning with tidymodels</span></span>
<span id="cb65-265"><a href="#cb65-265" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-266"><a href="#cb65-266" aria-hidden="true" tabindex="-1"></a>Instead of trying values one-by-one, we can **systematically search** over a grid of hyperparameters using grid search. </span>
<span id="cb65-267"><a href="#cb65-267" aria-hidden="true" tabindex="-1"></a>For more details: <span class="ot">&lt;https://www.tmwr.org/grid-search&gt;</span></span>
<span id="cb65-268"><a href="#cb65-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-269"><a href="#cb65-269" aria-hidden="true" tabindex="-1"></a><span class="fu">### 1. Create a tunable tree specification</span></span>
<span id="cb65-270"><a href="#cb65-270" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-273"><a href="#cb65-273" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-274"><a href="#cb65-274" aria-hidden="true" tabindex="-1"></a>tree_spec_tune <span class="ot">&lt;-</span> <span class="fu">decision_tree</span>(</span>
<span id="cb65-275"><a href="#cb65-275" aria-hidden="true" tabindex="-1"></a>  <span class="at">tree_depth =</span> <span class="fu">tune</span>(),</span>
<span id="cb65-276"><a href="#cb65-276" aria-hidden="true" tabindex="-1"></a>  <span class="at">min_n      =</span> <span class="fu">tune</span>()</span>
<span id="cb65-277"><a href="#cb65-277" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb65-278"><a href="#cb65-278" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_engine</span>(<span class="st">"rpart"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-279"><a href="#cb65-279" aria-hidden="true" tabindex="-1"></a>  <span class="fu">set_mode</span>(<span class="st">"classification"</span>)</span>
<span id="cb65-280"><a href="#cb65-280" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-281"><a href="#cb65-281" aria-hidden="true" tabindex="-1"></a>tree_spec_tune</span>
<span id="cb65-282"><a href="#cb65-282" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-283"><a href="#cb65-283" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-284"><a href="#cb65-284" aria-hidden="true" tabindex="-1"></a>Which parameters to try? There are default parameters that you can check associated to the model libraries <span class="ot">&lt;https://dials.tidymodels.org/articles/Basics.html&gt;</span> For example we could create models with these range of values and see which ones works best:</span>
<span id="cb65-285"><a href="#cb65-285" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-286"><a href="#cb65-286" aria-hidden="true" tabindex="-1"></a><span class="fu">### 3. Define a tuning grid</span></span>
<span id="cb65-287"><a href="#cb65-287" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-290"><a href="#cb65-290" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-291"><a href="#cb65-291" aria-hidden="true" tabindex="-1"></a>tree_grid <span class="ot">&lt;-</span> <span class="fu">grid_regular</span>(</span>
<span id="cb65-292"><a href="#cb65-292" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tree_depth</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">1</span>L, <span class="dv">10</span>L)),</span>
<span id="cb65-293"><a href="#cb65-293" aria-hidden="true" tabindex="-1"></a>  <span class="fu">min_n</span>(<span class="at">range =</span> <span class="fu">c</span>(<span class="dv">2</span>L, <span class="dv">30</span>L)),</span>
<span id="cb65-294"><a href="#cb65-294" aria-hidden="true" tabindex="-1"></a>  <span class="at">levels =</span> <span class="dv">5</span></span>
<span id="cb65-295"><a href="#cb65-295" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-296"><a href="#cb65-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-297"><a href="#cb65-297" aria-hidden="true" tabindex="-1"></a>tree_grid</span>
<span id="cb65-298"><a href="#cb65-298" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-299"><a href="#cb65-299" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-300"><a href="#cb65-300" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-303"><a href="#cb65-303" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-304"><a href="#cb65-304" aria-hidden="true" tabindex="-1"></a>tree_wf_cv <span class="ot">&lt;-</span> <span class="fu">workflow</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-305"><a href="#cb65-305" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_model</span>(tree_spec_tune) <span class="sc">%&gt;%</span></span>
<span id="cb65-306"><a href="#cb65-306" aria-hidden="true" tabindex="-1"></a>  <span class="fu">add_recipe</span>(tree_rec)</span>
<span id="cb65-307"><a href="#cb65-307" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-308"><a href="#cb65-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-309"><a href="#cb65-309" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-310"><a href="#cb65-310" aria-hidden="true" tabindex="-1"></a><span class="fu">### 4. Run `tune_grid()`</span></span>
<span id="cb65-311"><a href="#cb65-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-312"><a href="#cb65-312" aria-hidden="true" tabindex="-1"></a>For each combination in the grid, tidymodels fits a model and calculates accuracy and ROC AUC (metrics of choice for classification). We will see on Friday (and you saw yesterday) that the proper way of doing this is through cross-validation. Why is this needed? Because a single train/test split can give a lucky (or unlucky) result. Cross-validation gives a stable estimate of performance for each hyperparameter setting. But lets go one step at a time. </span>
<span id="cb65-313"><a href="#cb65-313" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-316"><a href="#cb65-316" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-317"><a href="#cb65-317" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb65-318"><a href="#cb65-318" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-319"><a href="#cb65-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-320"><a href="#cb65-320" aria-hidden="true" tabindex="-1"></a>tree_res <span class="ot">&lt;-</span> <span class="fu">tune_grid</span>(</span>
<span id="cb65-321"><a href="#cb65-321" aria-hidden="true" tabindex="-1"></a>  tree_wf_cv,</span>
<span id="cb65-322"><a href="#cb65-322" aria-hidden="true" tabindex="-1"></a>  <span class="at">resamples =</span> <span class="fu">bootstraps</span>(train_data, <span class="at">times =</span> <span class="dv">1</span>), <span class="co">#normally would have your crossvalidation info here - something like this (pima_folds &lt;- vfold_cv(train_data, v = 5)) - but will learn about this later on.</span></span>
<span id="cb65-323"><a href="#cb65-323" aria-hidden="true" tabindex="-1"></a>  <span class="at">grid      =</span> tree_grid,</span>
<span id="cb65-324"><a href="#cb65-324" aria-hidden="true" tabindex="-1"></a>  <span class="at">metrics   =</span> yardstick<span class="sc">::</span><span class="fu">metric_set</span>(yardstick<span class="sc">::</span>roc_auc, yardstick<span class="sc">::</span>accuracy)</span>
<span id="cb65-325"><a href="#cb65-325" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb65-326"><a href="#cb65-326" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-327"><a href="#cb65-327" aria-hidden="true" tabindex="-1"></a>tree_res</span>
<span id="cb65-328"><a href="#cb65-328" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-329"><a href="#cb65-329" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-330"><a href="#cb65-330" aria-hidden="true" tabindex="-1"></a>Inspect the best results (e.g. by ROC AUC):</span>
<span id="cb65-331"><a href="#cb65-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-334"><a href="#cb65-334" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-335"><a href="#cb65-335" aria-hidden="true" tabindex="-1"></a><span class="fu">show_best</span>(tree_res, <span class="at">metric =</span> <span class="st">"roc_auc"</span>, <span class="at">n =</span> <span class="dv">5</span>)</span>
<span id="cb65-336"><a href="#cb65-336" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-337"><a href="#cb65-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-340"><a href="#cb65-340" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-341"><a href="#cb65-341" aria-hidden="true" tabindex="-1"></a>tree_metrics <span class="ot">&lt;-</span> <span class="fu">collect_metrics</span>(tree_res) <span class="sc">%&gt;%</span></span>
<span id="cb65-342"><a href="#cb65-342" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(.metric <span class="sc">==</span> <span class="st">"roc_auc"</span>)</span>
<span id="cb65-343"><a href="#cb65-343" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-344"><a href="#cb65-344" aria-hidden="true" tabindex="-1"></a>tree_metrics</span>
<span id="cb65-345"><a href="#cb65-345" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-346"><a href="#cb65-346" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-347"><a href="#cb65-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-348"><a href="#cb65-348" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-351"><a href="#cb65-351" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-352"><a href="#cb65-352" aria-hidden="true" tabindex="-1"></a><span class="fu">autoplot</span>(tree_res)</span>
<span id="cb65-353"><a href="#cb65-353" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-354"><a href="#cb65-354" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-355"><a href="#cb65-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-356"><a href="#cb65-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-357"><a href="#cb65-357" aria-hidden="true" tabindex="-1"></a>Select the best hyperparameters and finalise the workflow:</span>
<span id="cb65-358"><a href="#cb65-358" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-361"><a href="#cb65-361" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-362"><a href="#cb65-362" aria-hidden="true" tabindex="-1"></a>best_tree <span class="ot">&lt;-</span> <span class="fu">select_best</span>(tree_res, <span class="at">metric =</span> <span class="st">"roc_auc"</span>)</span>
<span id="cb65-363"><a href="#cb65-363" aria-hidden="true" tabindex="-1"></a>best_tree</span>
<span id="cb65-364"><a href="#cb65-364" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-365"><a href="#cb65-365" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-368"><a href="#cb65-368" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-369"><a href="#cb65-369" aria-hidden="true" tabindex="-1"></a>final_tree_wf <span class="ot">&lt;-</span> <span class="fu">finalize_workflow</span>(tree_wf_cv, best_tree)</span>
<span id="cb65-370"><a href="#cb65-370" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-371"><a href="#cb65-371" aria-hidden="true" tabindex="-1"></a>final_tree_fit <span class="ot">&lt;-</span> final_tree_wf <span class="sc">%&gt;%</span></span>
<span id="cb65-372"><a href="#cb65-372" aria-hidden="true" tabindex="-1"></a>  <span class="fu">fit</span>(<span class="at">data =</span> train_data)</span>
<span id="cb65-373"><a href="#cb65-373" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-374"><a href="#cb65-374" aria-hidden="true" tabindex="-1"></a>final_tree_fit</span>
<span id="cb65-375"><a href="#cb65-375" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-376"><a href="#cb65-376" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-377"><a href="#cb65-377" aria-hidden="true" tabindex="-1"></a><span class="fu">### 5. Evaluate the tuned tree on the test set</span></span>
<span id="cb65-378"><a href="#cb65-378" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-381"><a href="#cb65-381" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-382"><a href="#cb65-382" aria-hidden="true" tabindex="-1"></a>train_preds_final <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_tree_fit, train_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-383"><a href="#cb65-383" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(final_tree_fit, train_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-384"><a href="#cb65-384" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(train_data)</span>
<span id="cb65-385"><a href="#cb65-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-386"><a href="#cb65-386" aria-hidden="true" tabindex="-1"></a>test_preds_final <span class="ot">&lt;-</span> <span class="fu">predict</span>(final_tree_fit, test_data, <span class="at">type =</span> <span class="st">"prob"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-387"><a href="#cb65-387" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(<span class="fu">predict</span>(final_tree_fit, test_data, <span class="at">type =</span> <span class="st">"class"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb65-388"><a href="#cb65-388" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_cols</span>(test_data)</span>
<span id="cb65-389"><a href="#cb65-389" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-390"><a href="#cb65-390" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-393"><a href="#cb65-393" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-394"><a href="#cb65-394" aria-hidden="true" tabindex="-1"></a>train_metrics_final <span class="ot">&lt;-</span> train_preds_final <span class="sc">%&gt;%</span></span>
<span id="cb65-395"><a href="#cb65-395" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-396"><a href="#cb65-396" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-397"><a href="#cb65-397" aria-hidden="true" tabindex="-1"></a>test_metrics_final <span class="ot">&lt;-</span> test_preds_final <span class="sc">%&gt;%</span></span>
<span id="cb65-398"><a href="#cb65-398" aria-hidden="true" tabindex="-1"></a>  <span class="fu">class_metrics</span>(<span class="at">truth =</span> diabetes, <span class="at">estimate =</span> .pred_class)</span>
<span id="cb65-399"><a href="#cb65-399" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-400"><a href="#cb65-400" aria-hidden="true" tabindex="-1"></a>train_metrics_final</span>
<span id="cb65-401"><a href="#cb65-401" aria-hidden="true" tabindex="-1"></a>test_metrics_final</span>
<span id="cb65-402"><a href="#cb65-402" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-403"><a href="#cb65-403" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-404"><a href="#cb65-404" aria-hidden="true" tabindex="-1"></a>We can also compare ROC AUC:</span>
<span id="cb65-405"><a href="#cb65-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-408"><a href="#cb65-408" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-409"><a href="#cb65-409" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_auc</span>(train_preds_final, <span class="at">truth =</span> diabetes, .pred_pos)</span>
<span id="cb65-410"><a href="#cb65-410" aria-hidden="true" tabindex="-1"></a><span class="fu">roc_auc</span>(test_preds_final,  <span class="at">truth =</span> diabetes, .pred_pos)</span>
<span id="cb65-411"><a href="#cb65-411" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-412"><a href="#cb65-412" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-413"><a href="#cb65-413" aria-hidden="true" tabindex="-1"></a>And visualise the final tree:</span>
<span id="cb65-414"><a href="#cb65-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-417"><a href="#cb65-417" aria-hidden="true" tabindex="-1"></a><span class="in">```{r}</span></span>
<span id="cb65-418"><a href="#cb65-418" aria-hidden="true" tabindex="-1"></a>final_tree_fit <span class="sc">%&gt;%</span></span>
<span id="cb65-419"><a href="#cb65-419" aria-hidden="true" tabindex="-1"></a>  <span class="fu">extract_fit_parsnip</span>() <span class="sc">%&gt;%</span></span>
<span id="cb65-420"><a href="#cb65-420" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pluck</span>(<span class="st">"fit"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb65-421"><a href="#cb65-421" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rpart.plot</span>(<span class="at">extra =</span> <span class="dv">101</span>)</span>
<span id="cb65-422"><a href="#cb65-422" aria-hidden="true" tabindex="-1"></a><span class="in">```</span></span>
<span id="cb65-423"><a href="#cb65-423" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-424"><a href="#cb65-424" aria-hidden="true" tabindex="-1"></a>---</span>
<span id="cb65-425"><a href="#cb65-425" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-426"><a href="#cb65-426" aria-hidden="true" tabindex="-1"></a><span class="fu">### Key messages</span></span>
<span id="cb65-427"><a href="#cb65-427" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-428"><a href="#cb65-428" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>A **basic tree** can easily overfit: high training accuracy, lower test accuracy.  </span>
<span id="cb65-429"><a href="#cb65-429" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**Hyperparameters** like <span class="in">`tree_depth`</span> and <span class="in">`min_n`</span> control complexity and help reduce overfitting.  </span>
<span id="cb65-430"><a href="#cb65-430" aria-hidden="true" tabindex="-1"></a><span class="ss">- </span>**tidymodels** lets us:</span>
<span id="cb65-431"><a href="#cb65-431" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>define tunable specifications (<span class="in">`tune()`</span>),</span>
<span id="cb65-432"><a href="#cb65-432" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>keep preprocessing and modelling together in **workflows**,</span>
<span id="cb65-433"><a href="#cb65-433" aria-hidden="true" tabindex="-1"></a><span class="ss">  - </span>and only evaluate on the **test set once** at the very end.  </span>
<span id="cb65-434"><a href="#cb65-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-435"><a href="#cb65-435" aria-hidden="true" tabindex="-1"></a>Remember:  </span>
<span id="cb65-436"><a href="#cb65-436" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; Hyperparameter tuning is part of the training process.</span>  </span>
<span id="cb65-437"><a href="#cb65-437" aria-hidden="true" tabindex="-1"></a><span class="at">&gt; The **test set must never be used** to choose hyperparameters – only to evaluate the final chosen model.</span></span>
</code><button title="Copy to Clipboard" class="code-copy-button" data-in-quarto-modal=""><i class="bi"></i></button></pre></div>
</div></div></div></div></div>
</div> <!-- /content -->
<footer class="footer"><div class="nav-footer">
    <div class="nav-footer-left">
<p>Copyright 2025, Laura Bravo</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
<li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/laura_bravo94">
      <i class="bi bi-twitter" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/LauBra/RIntro2023">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
</div>
  </div>
</footer>


</body></html>